# 01-本地开发

## 概述

本地开发是 LangGraph 应用开发的起点，通过 LangGraph CLI 和 Studio 提供完整的开发调试环境。本地环境支持快速迭代、实时调试和可视化图形编辑。

## 开发工具栈

### LangGraph CLI
命令行工具，用于创建、管理和运行 LangGraph 应用

### LangGraph Studio
可视化 IDE，提供图形界面进行调试和交互

### 本地服务器
在本地运行完整的 LangGraph 服务，支持 API 调用和 WebUI

## 环境准备

### 系统要求
- Python 3.8+
- Node.js 16+ (可选，用于前端开发)
- Git
- 至少 4GB 可用内存

### 核心依赖安装
```bash
# 安装 LangGraph CLI
pip install langgraph-cli

# 验证安装
langgraph --version

# 安装核心依赖
pip install langgraph langchain_openai python-dotenv
```

## 快速开始

### 1. 创建新项目
```bash
# 使用模板创建项目
langgraph new my-agent --template=react-agent

# 进入项目目录
cd my-agent

# 查看项目结构
tree .
```

### 2. 项目结构解析
```
my-agent/
├── langgraph.json          # 项目配置文件
├── requirements.txt        # Python依赖
├── .env.example           # 环境变量模板
├── src/
│   ├── my_agent/
│   │   ├── graph.py       # 图定义
│   │   └── state.py       # 状态定义
│   └── __init__.py
└── tests/                 # 测试文件
```

### 3. 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
nano .env
```

**`.env` 文件示例：**
```bash
# OpenAI API配置
OPENAI_API_KEY=your_openai_api_key_here

# LangSmith追踪（可选）
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=your_langsmith_api_key
LANGCHAIN_PROJECT=my-agent-local

# 其他配置
DEBUG=true
LOG_LEVEL=INFO
```

### 4. 安装项目依赖
```bash
# 安装依赖
pip install -r requirements.txt

# 或使用虚拟环境
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# .venv\Scripts\activate   # Windows
pip install -r requirements.txt
```

## LangGraph CLI 使用

### 核心命令
```bash
# 创建新应用
langgraph new <app_name> [--template=<template_name>]

# 启动开发服务器
langgraph dev

# 构建应用
langgraph build

# 运行测试
langgraph test

# 查看项目信息
langgraph info

# 升级CLI
langgraph update
```

### 开发服务器
```bash
# 启动带热重载的开发服务器
langgraph dev

# 指定端口
langgraph dev --port 8123

# 启用调试模式
langgraph dev --debug

# 监听所有接口
langgraph dev --host 0.0.0.0
```

**输出示例：**
```
🚀 LangGraph Server starting...
📊 LangGraph Studio: http://localhost:8123
🔧 API Endpoint: http://localhost:8123/api
📝 Documentation: http://localhost:8123/docs
✅ Server ready! Watching for changes...
```

## LangGraph Studio 使用

### 访问 Studio
1. 启动开发服务器：`langgraph dev`
2. 打开浏览器访问：`http://localhost:8123`
3. 选择工作模式：Graph 模式或 Chat 模式

### Graph 模式
可视化图形编辑和调试模式

**主要功能：**
- 图形可视化展示
- 节点状态检查
- 执行流程追踪
- 断点调试
- 状态时间旅行

**使用步骤：**
1. 在左侧面板选择图
2. 在输入框中输入测试数据
3. 点击 "Run" 执行图
4. 在右侧查看执行结果和日志

### Chat 模式
对话式交互模式

**主要功能：**
- 实时对话测试
- 消息历史管理
- 多轮对话支持
- 工具调用展示

## 本地配置文件

### langgraph.json
项目的核心配置文件

```json
{
  "dependencies": ["."],
  "graphs": {
    "my_agent": "./src/my_agent/graph.py:graph"
  },
  "env": ".env",
  "python_version": "3.11",
  "pip_config_file": "./pyproject.toml",
  "dockerfile_lines": [
    "RUN apt-get update && apt-get install -y git"
  ]
}
```

**配置项说明：**
- `dependencies`: 依赖路径
- `graphs`: 图定义映射
- `env`: 环境变量文件
- `python_version`: Python版本
- `pip_config_file`: pip配置文件
- `dockerfile_lines`: 自定义Docker指令

### requirements.txt
```txt
langgraph>=0.2.0
langchain>=0.3.0
langchain_openai>=0.2.0
python-dotenv>=1.0.0
pydantic>=2.0.0
typing-extensions>=4.0.0
```

## 调试技巧

### 1. 日志配置
```python
import logging

# 配置日志级别
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# 在节点中添加日志
def my_node(state):
    logging.info(f"处理状态: {state}")
    # 节点逻辑
    return {"output": "processed"}
```

### 2. 断点调试
```python
# 在图编译时设置断点
app = graph.compile(
    checkpointer=memory,
    interrupt_before=["human_review"],  # 在指定节点前中断
    interrupt_after=["data_processing"]  # 在指定节点后中断
)

# 运行时设置断点
app.invoke(
    {"input": "test"},
    config={"configurable": {"thread_id": "1"}},
    debug=True  # 启用调试模式
)
```

### 3. 状态检查
```python
# 获取当前状态
state = app.get_state(config={"configurable": {"thread_id": "1"}})
print(f"当前状态: {state.values}")
print(f"下一步: {state.next}")

# 状态历史
history = app.get_state_history(
    config={"configurable": {"thread_id": "1"}}
)
for checkpoint in history:
    print(f"步骤 {checkpoint.metadata['step']}: {checkpoint.values}")
```

## 热重载开发

### 代码变更检测
```bash
# 启动开发服务器（自动热重载）
langgraph dev

# 监控特定文件
langgraph dev --watch src/
```

**支持热重载的文件类型：**
- `.py` Python源文件
- `langgraph.json` 配置文件
- `.env` 环境变量文件
- `requirements.txt` 依赖文件

### 开发工作流
1. 修改代码文件
2. 保存文件（触发热重载）
3. 在 Studio 中测试变更
4. 查看日志输出
5. 重复迭代

## 性能优化

### 1. 依赖缓存
```bash
# 使用pip缓存
pip install --cache-dir .pip-cache -r requirements.txt

# 清理缓存
pip cache purge
```

### 2. 并发配置
```python
# 在图配置中设置并发
app = graph.compile(
    checkpointer=memory,
    max_concurrency=4  # 最大并发数
)
```

### 3. 内存管理
```python
import gc

def memory_intensive_node(state):
    # 处理大量数据
    result = process_large_data(state["data"])

    # 手动触发垃圾回收
    gc.collect()

    return {"result": result}
```

## 环境隔离

### 虚拟环境
```bash
# 创建虚拟环境
python -m venv langgraph-env

# 激活环境
source langgraph-env/bin/activate  # Linux/Mac
# langgraph-env\Scripts\activate    # Windows

# 安装依赖
pip install -r requirements.txt

# 验证环境
which python
pip list
```

### Docker 开发环境
```dockerfile
# Dockerfile.dev
FROM python:3.11-slim

WORKDIR /app

# 安装开发依赖
COPY requirements.txt .
RUN pip install -r requirements.txt

# 复制源码
COPY . .

# 暴露端口
EXPOSE 8123

# 启动开发服务器
CMD ["langgraph", "dev", "--host", "0.0.0.0"]
```

```bash
# 构建开发镜像
docker build -f Dockerfile.dev -t my-agent-dev .

# 运行开发容器
docker run -p 8123:8123 -v $(pwd):/app my-agent-dev
```

## 故障排除

### 常见问题

#### 1. 依赖冲突
```bash
# 检查依赖
pip check

# 创建新的虚拟环境
rm -rf .venv
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

#### 2. 端口被占用
```bash
# 查找占用端口的进程
lsof -i :8123

# 杀死进程
kill -9 <PID>

# 使用其他端口
langgraph dev --port 8124
```

#### 3. 环境变量未生效
```bash
# 检查环境变量
printenv | grep OPENAI

# 手动加载环境变量
export $(cat .env | xargs)

# 验证配置
python -c "import os; print(os.getenv('OPENAI_API_KEY'))"
```

#### 4. 图无法加载
```python
# 检查图定义
python -c "from src.my_agent.graph import graph; print(graph)"

# 验证图结构
graph.get_graph().print_ascii()
```

## 开发最佳实践

### 1. 项目结构
```
my-agent/
├── src/
│   ├── agents/           # Agent定义
│   ├── tools/           # 工具函数
│   ├── graphs/          # 图定义
│   ├── states/          # 状态类
│   └── utils/           # 工具函数
├── tests/               # 测试代码
├── docs/               # 文档
├── data/               # 数据文件
└── logs/               # 日志文件
```

### 2. 代码组织
```python
# states.py - 统一状态定义
from typing import TypedDict, List
from langgraph.graph import add_messages

class AgentState(TypedDict):
    messages: List[dict]
    user_input: str
    result: str

# nodes.py - 节点函数
def process_input_node(state: AgentState) -> AgentState:
    """处理用户输入"""
    return {"processed_input": state["user_input"].strip()}

# graph.py - 图定义
from langgraph.graph import StateGraph, END
from .states import AgentState
from .nodes import process_input_node

def create_graph():
    graph = StateGraph(AgentState)
    graph.add_node("process", process_input_node)
    graph.add_edge("process", END)
    graph.set_entry_point("process")
    return graph.compile()
```

### 3. 测试驱动开发
```python
# tests/test_graph.py
import pytest
from src.my_agent.graph import create_graph

def test_basic_flow():
    app = create_graph()
    result = app.invoke({"user_input": "Hello"})
    assert "processed_input" in result
    assert result["processed_input"] == "Hello"

def test_empty_input():
    app = create_graph()
    result = app.invoke({"user_input": ""})
    assert result["processed_input"] == ""
```

### 4. 版本控制
```gitignore
# .gitignore
.env
.venv/
__pycache__/
*.pyc
.pytest_cache/
logs/
.DS_Store
*.log
```

## 下一步

- 📖 学习 [02-云部署](./02-云部署.md) - 将应用部署到生产环境
- 🔧 探索 [04-监控与追踪](./04-监控与追踪.md) - 添加监控和调试功能
- 🐳 了解 [06-Docker容器化](./06-Docker容器化.md) - 容器化部署方案

## 相关链接

- [LangGraph CLI 官方文档](https://langchain-ai.github.io/langgraph/concepts/langgraph_cli/)
- [LangGraph Studio 指南](https://langchain-ai.github.io/langgraph/concepts/langgraph_studio/)
- [模板应用](https://langchain-ai.github.io/langgraph/concepts/template_applications/)
- [应用结构规范](https://langchain-ai.github.io/langgraph/concepts/application_structure/)