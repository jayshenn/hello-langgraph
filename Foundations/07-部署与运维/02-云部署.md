# 02-云部署

## 概述

LangGraph Cloud SaaS 是官方提供的托管服务，提供零运维的生产级部署环境。通过 GitHub 集成实现自动化 CI/CD，支持多环境管理、自动扩展和内置监控。

## Cloud SaaS 架构

### 控制平面 (Control Plane)
- **Web UI**: 项目管理、部署配置
- **API**: 程序化管理接口
- **GitHub 集成**: 自动部署流水线
- **环境管理**: 开发、测试、生产环境

### 数据平面 (Data Plane)
- **LangGraph 服务器**: 执行 Agent 应用
- **任务队列**: 异步作业处理
- **持久化存储**: 状态和检查点
- **监控系统**: 性能指标和日志

### 服务特性
- ✅ 零基础设施管理
- ✅ 自动扩展和负载均衡
- ✅ 内置监控和日志
- ✅ 多区域部署
- ✅ 企业级安全
- ✅ SLA 保证

## 部署准备

### 1. 账号设置
```bash
# 访问 LangGraph Platform
# https://langchain-ai.github.io/langgraph/cloud/

# 使用 GitHub 账号登录
# 或注册新的 LangSmith 账号
```

### 2. GitHub 仓库准备
```bash
# 确保代码已推送到 GitHub
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/username/my-agent.git
git push -u origin main
```

### 3. 项目结构要求
```
my-agent/
├── langgraph.json          # 必需：项目配置
├── requirements.txt        # 或 pyproject.toml
├── .env.example           # 环境变量模板
├── src/
│   └── my_agent/
│       ├── __init__.py
│       ├── graph.py       # 图定义
│       └── state.py       # 状态定义
└── README.md              # 项目说明
```

## 配置文件

### langgraph.json
```json
{
  "dependencies": ["."],
  "graphs": {
    "my_agent": "./src/my_agent/graph.py:graph"
  },
  "env": ".env",
  "python_version": "3.11",
  "pip_config_file": "pyproject.toml",
  "dockerfile_lines": [
    "RUN apt-get update && apt-get install -y curl",
    "RUN pip install --upgrade pip"
  ]
}
```

**核心配置说明：**
- `dependencies`: 包依赖路径
- `graphs`: 图定义映射关系
- `env`: 环境变量配置文件
- `python_version`: 运行时 Python 版本
- `dockerfile_lines`: 自定义构建指令

### requirements.txt
```txt
langgraph>=0.2.0
langchain>=0.3.0
langchain_openai>=0.2.0
langchain_community>=0.3.0
python-dotenv>=1.0.0
pydantic>=2.0.0
requests>=2.31.0
aiohttp>=3.9.0
```

### pyproject.toml (可选)
```toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "my-agent"
version = "0.1.0"
description = "My LangGraph Agent"
dependencies = [
    "langgraph>=0.2.0",
    "langchain>=0.3.0",
    "langchain_openai>=0.2.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "black>=23.0.0",
    "isort>=5.12.0",
]
```

## 部署流程

### 1. 创建部署

#### 通过 Web UI
1. 登录 LangGraph Platform
2. 点击 "New Deployment"
3. 选择 GitHub 仓库
4. 配置部署设置
5. 点击 "Deploy"

#### 部署配置选项
```yaml
# 部署配置示例
name: "my-agent-prod"
repository: "username/my-agent"
branch: "main"
environment: "production"
region: "us-east-1"
instance_type: "standard"
auto_deploy: true
environment_variables:
  - OPENAI_API_KEY: "sk-..."
  - LANGCHAIN_TRACING_V2: "true"
  - LOG_LEVEL: "INFO"
```

### 2. 环境变量配置

#### 在 Platform UI 中设置
```bash
# 必需的环境变量
OPENAI_API_KEY=sk-your_openai_api_key_here

# LangSmith 追踪（推荐）
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=your_langsmith_api_key
LANGCHAIN_PROJECT=my-agent-prod

# 应用配置
LOG_LEVEL=INFO
MAX_WORKERS=4
REQUEST_TIMEOUT=30
```

#### 敏感信息管理
- 🔐 所有环境变量加密存储
- 🔄 支持运行时更新
- 🔍 访问审计日志
- 🚫 防止意外泄露

### 3. 自动部署设置

#### GitHub Webhooks
自动配置，当代码推送时触发部署：

```yaml
# .github/workflows/deploy.yml（可选）
name: Deploy to LangGraph Platform

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to LangGraph Platform
        run: |
          echo "部署由 LangGraph Platform 自动处理"
```

#### 分支策略
```bash
# 开发环境：dev 分支
git checkout -b dev
git push origin dev

# 测试环境：staging 分支
git checkout -b staging
git push origin staging

# 生产环境：main 分支
git checkout main
git push origin main
```

## 多环境管理

### 环境类型
1. **开发环境 (Development)**
   - 分支：`dev`
   - 实例：最小配置
   - 用途：功能开发和测试

2. **测试环境 (Staging)**
   - 分支：`staging`
   - 实例：生产相似配置
   - 用途：集成测试和验收

3. **生产环境 (Production)**
   - 分支：`main`
   - 实例：高可用配置
   - 用途：用户访问

### 环境配置差异
```json
// langgraph.json - 开发环境
{
  "dependencies": ["."],
  "graphs": {
    "my_agent": "./src/my_agent/graph.py:graph"
  },
  "env": ".env.dev",
  "python_version": "3.11"
}

// langgraph.json - 生产环境
{
  "dependencies": ["."],
  "graphs": {
    "my_agent": "./src/my_agent/graph.py:graph"
  },
  "env": ".env.prod",
  "python_version": "3.11",
  "dockerfile_lines": [
    "RUN apt-get update && apt-get install -y curl",
    "RUN pip install --no-cache-dir --upgrade pip"
  ]
}
```

## 部署监控

### 部署状态查看
```bash
# 在 Platform UI 中查看：
# 1. 部署状态：构建中/成功/失败
# 2. 构建日志：详细的构建过程
# 3. 运行时日志：应用执行日志
# 4. 性能指标：CPU、内存、请求量
```

### 日志管理
```python
# 在应用中配置日志
import logging
import os

# 配置日志级别
log_level = os.getenv("LOG_LEVEL", "INFO")
logging.basicConfig(
    level=getattr(logging, log_level),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),  # 输出到控制台
    ]
)

logger = logging.getLogger(__name__)

def my_node(state):
    logger.info(f"处理请求: {state.get('input', 'N/A')}")
    # 节点逻辑
    return {"result": "processed"}
```

### 健康检查
```python
# 添加健康检查端点
from fastapi import FastAPI
from langgraph.graph import StateGraph

app = FastAPI()

@app.get("/health")
async def health_check():
    """健康检查端点"""
    return {
        "status": "healthy",
        "service": "my-agent",
        "version": "1.0.0"
    }

@app.get("/ready")
async def readiness_check():
    """就绪检查端点"""
    try:
        # 检查依赖服务
        # 例如：数据库连接、外部API等
        return {"status": "ready"}
    except Exception as e:
        return {"status": "not ready", "error": str(e)}
```

## API 访问

### 获取部署信息
```python
# 使用 LangGraph SDK
from langgraph_sdk import get_client

# 连接到部署的应用
client = get_client(
    url="https://your-deployment.langchain.app",
    api_key="your_api_key"
)

# 列出可用的图
graphs = client.assistants.search()
print(f"可用图: {[g.name for g in graphs]}")

# 创建会话
thread = client.threads.create()
print(f"会话ID: {thread.thread_id}")
```

### 调用部署的图
```python
# 同步调用
response = client.runs.create(
    thread_id=thread.thread_id,
    assistant_id="my_agent",
    input={"input": "Hello, world!"}
)

# 流式调用
for chunk in client.runs.stream(
    thread_id=thread.thread_id,
    assistant_id="my_agent",
    input={"input": "Tell me a story"},
    stream_mode="values"
):
    print(chunk)
```

### REST API 调用
```bash
# 直接使用 HTTP API
curl -X POST "https://your-deployment.langchain.app/runs/stream" \
  -H "Authorization: Bearer your_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "assistant_id": "my_agent",
    "input": {"input": "Hello!"},
    "config": {"configurable": {"thread_id": "test-thread"}},
    "stream_mode": "values"
  }'
```

## 扩展配置

### 实例类型
```yaml
# 可用实例类型
instance_types:
  - name: "micro"
    cpu: "0.25 vCPU"
    memory: "0.5 GB"
    price: "$0.01/hour"

  - name: "small"
    cpu: "0.5 vCPU"
    memory: "1 GB"
    price: "$0.02/hour"

  - name: "standard"
    cpu: "1 vCPU"
    memory: "2 GB"
    price: "$0.04/hour"

  - name: "large"
    cpu: "2 vCPU"
    memory: "4 GB"
    price: "$0.08/hour"
```

### 自动扩展
```json
{
  "scaling": {
    "min_instances": 1,
    "max_instances": 10,
    "target_cpu_utilization": 70,
    "scale_up_cooldown": "2m",
    "scale_down_cooldown": "5m"
  }
}
```

## 版本管理

### 部署版本
```bash
# 每次部署都会创建新版本
# 版本命名规则：v1.0.0, v1.0.1, v1.1.0

# 在 Platform UI 中可以：
# 1. 查看版本历史
# 2. 回滚到之前版本
# 3. 比较版本差异
# 4. 设置流量分配
```

### 蓝绿部署
```yaml
# 零停机部署策略
deployment_strategy:
  type: "blue_green"
  health_check_path: "/health"
  health_check_interval: "30s"
  rollback_on_failure: true
```

### 金丝雀发布
```yaml
# 渐进式发布
deployment_strategy:
  type: "canary"
  stages:
    - percentage: 10
      duration: "10m"
    - percentage: 50
      duration: "20m"
    - percentage: 100
```

## 成本优化

### 使用建议
1. **选择合适的实例类型**
   - 开发环境：micro/small
   - 生产环境：根据负载选择

2. **配置自动扩展**
   - 避免过度配置
   - 设置合理的扩展策略

3. **监控资源使用**
   - 定期检查 CPU/内存使用率
   - 优化代码性能

### 成本监控
```python
# 在应用中添加成本追踪
import time
from functools import wraps

def track_execution_time(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        execution_time = time.time() - start_time

        # 记录执行时间（用于成本分析）
        logger.info(f"Function {func.__name__} took {execution_time:.2f}s")
        return result
    return wrapper

@track_execution_time
def expensive_node(state):
    # 计算密集型操作
    return {"result": "computed"}
```

## 故障排除

### 常见部署错误

#### 1. 构建失败
```bash
# 错误：依赖安装失败
ERROR: pip install failed

# 解决方案：
# 1. 检查 requirements.txt 格式
# 2. 确保版本兼容性
# 3. 添加 --no-cache-dir 到 dockerfile_lines
```

#### 2. 图加载失败
```bash
# 错误：无法导入图定义
ImportError: cannot import name 'graph'

# 解决方案：
# 1. 检查 langgraph.json 中的路径
# 2. 确保 __init__.py 文件存在
# 3. 验证图定义语法
```

#### 3. 环境变量问题
```bash
# 错误：API 密钥未设置
KeyError: 'OPENAI_API_KEY'

# 解决方案：
# 1. 在 Platform UI 中设置环境变量
# 2. 检查变量名拼写
# 3. 验证变量值格式
```

### 调试技巧

#### 1. 查看构建日志
```bash
# 在 Platform UI 中：
# Deployments → 选择部署 → Build Logs
# 查看详细的构建过程和错误信息
```

#### 2. 运行时调试
```python
# 添加详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

def debug_node(state):
    logging.debug(f"节点输入: {state}")
    # 处理逻辑
    result = {"output": "processed"}
    logging.debug(f"节点输出: {result}")
    return result
```

#### 3. 健康检查调试
```bash
# 测试健康检查端点
curl https://your-deployment.langchain.app/health

# 检查应用就绪状态
curl https://your-deployment.langchain.app/ready
```

## 安全最佳实践

### 1. 环境变量安全
- 🔐 永远不要在代码中硬编码密钥
- 🔄 定期轮换 API 密钥
- 🚫 不要在日志中输出敏感信息

### 2. 网络安全
- 🌐 使用 HTTPS 进行所有通信
- 🔒 配置适当的 CORS 策略
- 🛡️ 启用请求速率限制

### 3. 代码安全
```python
# 避免代码注入
def safe_eval(user_input):
    # ❌ 危险做法
    # result = eval(user_input)

    # ✅ 安全做法
    import ast
    try:
        parsed = ast.parse(user_input, mode='eval')
        # 验证 AST 节点类型
        return "safe"
    except:
        return "unsafe"
```

## 下一步

- 🔧 探索 [03-自托管](./03-自托管.md) - 自主控制部署环境
- 📊 学习 [04-监控与追踪](./04-监控与追踪.md) - 深入监控和调试
- 🔐 了解 [07-认证与授权](./07-认证与授权.md) - 增强应用安全性

## 相关链接

- [LangGraph Platform 快速开始](https://langchain-ai.github.io/langgraph/cloud/quick_start/)
- [Cloud SaaS 部署指南](https://langchain-ai.github.io/langgraph/cloud/deployment/cloud/)
- [应用结构配置](https://langchain-ai.github.io/langgraph/concepts/application_structure/)
- [LangGraph Platform 概念](https://langchain-ai.github.io/langgraph/concepts/langgraph_platform/)