# Python å¼‚æ­¥ç¼–ç¨‹åŸºç¡€

> ğŸ¯ **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡ Python å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒæ¦‚å¿µï¼Œç†è§£ LangGraph ä¸­çš„å¼‚æ­¥æœºåˆ¶

## ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ç¼–ç¨‹ï¼Ÿ

åœ¨ LangGraph åº”ç”¨ä¸­ï¼Œä½ ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼š

```python
# ä¸²è¡Œå¤„ç†ï¼šæ…¢é€Ÿæ“ä½œ
def slow_operations():
    result1 = call_llm_api("é—®é¢˜1")          # éœ€è¦ 2 ç§’
    result2 = search_database("æŸ¥è¯¢1")       # éœ€è¦ 1 ç§’
    result3 = call_external_api("è¯·æ±‚1")     # éœ€è¦ 3 ç§’
    return [result1, result2, result3]      # æ€»å…±éœ€è¦ 6 ç§’

# å¼‚æ­¥å¤„ç†ï¼šå¹¶å‘æ‰§è¡Œ
async def fast_operations():
    task1 = call_llm_api("é—®é¢˜1")           # å¹¶å‘æ‰§è¡Œ
    task2 = search_database("æŸ¥è¯¢1")        # å¹¶å‘æ‰§è¡Œ
    task3 = call_external_api("è¯·æ±‚1")      # å¹¶å‘æ‰§è¡Œ
    results = await asyncio.gather(task1, task2, task3)  # æ€»å…±åªéœ€è¦ 3 ç§’
    return results
```

## ğŸ“– å¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒæ¦‚å¿µ

### 1. åç¨‹ (Coroutine)

åç¨‹æ˜¯å¯ä»¥æš‚åœå’Œæ¢å¤çš„å‡½æ•°ï¼š

```python
import asyncio

# æ™®é€šå‡½æ•°
def sync_function():
    print("è¿™æ˜¯åŒæ­¥å‡½æ•°")
    return "åŒæ­¥ç»“æœ"

# åç¨‹å‡½æ•°
async def async_function():
    print("è¿™æ˜¯å¼‚æ­¥å‡½æ•°")
    await asyncio.sleep(1)  # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    return "å¼‚æ­¥ç»“æœ"

# è¿è¡Œåç¨‹
async def main():
    result = await async_function()
    print(result)

# æ‰§è¡Œ
asyncio.run(main())
```

### 2. await å…³é”®å­—

`await` ç”¨äºç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼š

```python
import asyncio
import time

async def simulate_llm_call(prompt: str) -> str:
    """æ¨¡æ‹Ÿ LLM API è°ƒç”¨"""
    print(f"ğŸ¤– å¼€å§‹å¤„ç†: {prompt}")
    await asyncio.sleep(2)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    print(f"âœ… å¤„ç†å®Œæˆ: {prompt}")
    return f"å›ç­”: {prompt} çš„å“åº”"

async def simulate_database_query(query: str) -> str:
    """æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢"""
    print(f"ğŸ—„ï¸ å¼€å§‹æŸ¥è¯¢: {query}")
    await asyncio.sleep(1)  # æ¨¡æ‹ŸæŸ¥è¯¢æ—¶é—´
    print(f"âœ… æŸ¥è¯¢å®Œæˆ: {query}")
    return f"æŸ¥è¯¢ç»“æœ: {query}"

# ä¸²è¡Œæ‰§è¡Œï¼ˆæ…¢ï¼‰
async def sequential_example():
    start_time = time.time()

    result1 = await simulate_llm_call("ä»€ä¹ˆæ˜¯ AIï¼Ÿ")
    result2 = await simulate_database_query("ç”¨æˆ·ä¿¡æ¯")

    end_time = time.time()
    print(f"â±ï¸ ä¸²è¡Œæ‰§è¡Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
    return [result1, result2]

# å¹¶å‘æ‰§è¡Œï¼ˆå¿«ï¼‰
async def concurrent_example():
    start_time = time.time()

    # åŒæ—¶å¯åŠ¨å¤šä¸ªä»»åŠ¡
    task1 = simulate_llm_call("ä»€ä¹ˆæ˜¯ AIï¼Ÿ")
    task2 = simulate_database_query("ç”¨æˆ·ä¿¡æ¯")

    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    results = await asyncio.gather(task1, task2)

    end_time = time.time()
    print(f"â±ï¸ å¹¶å‘æ‰§è¡Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
    return results

# æµ‹è¯•
async def main():
    print("=== ä¸²è¡Œæ‰§è¡Œ ===")
    await sequential_example()

    print("\n=== å¹¶å‘æ‰§è¡Œ ===")
    await concurrent_example()

# è¿è¡Œ
asyncio.run(main())
```

## ğŸ” LangGraph ä¸­çš„å¼‚æ­¥åº”ç”¨

### 1. å¼‚æ­¥èŠ‚ç‚¹å‡½æ•°

åœ¨ LangGraph ä¸­ï¼ŒèŠ‚ç‚¹å‡½æ•°å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼š

```python
from typing import TypedDict
import asyncio

class ChatState(TypedDict):
    user_input: str
    llm_response: str
    search_results: str
    final_answer: str

# å¼‚æ­¥ LLM èŠ‚ç‚¹
async def llm_node(state: ChatState) -> ChatState:
    """è°ƒç”¨ LLM ç”Ÿæˆå“åº”"""
    prompt = f"ç”¨æˆ·é—®é¢˜: {state['user_input']}"

    # æ¨¡æ‹Ÿå¼‚æ­¥ LLM è°ƒç”¨
    await asyncio.sleep(1.5)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    response = f"LLM å›ç­”: å…³äº '{state['user_input']}' çš„å›ç­”"

    return {
        **state,
        "llm_response": response
    }

# å¼‚æ­¥æœç´¢èŠ‚ç‚¹
async def search_node(state: ChatState) -> ChatState:
    """æ‰§è¡Œæœç´¢æ“ä½œ"""
    query = state['user_input']

    # æ¨¡æ‹Ÿå¼‚æ­¥æœç´¢
    await asyncio.sleep(1)  # æ¨¡æ‹Ÿæœç´¢å»¶è¿Ÿ
    results = f"æœç´¢ç»“æœ: æ‰¾åˆ°å…³äº '{query}' çš„ç›¸å…³ä¿¡æ¯"

    return {
        **state,
        "search_results": results
    }

# å¼‚æ­¥ç»¼åˆèŠ‚ç‚¹
async def synthesis_node(state: ChatState) -> ChatState:
    """ç»¼åˆ LLM å“åº”å’Œæœç´¢ç»“æœ"""
    await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´

    final_answer = f"""
    ç»¼åˆå›ç­”:
    - LLM è§‚ç‚¹: {state['llm_response']}
    - æœç´¢è¡¥å……: {state['search_results']}
    """

    return {
        **state,
        "final_answer": final_answer.strip()
    }
```

### 2. å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡

```python
# å¹¶å‘æ‰§è¡Œå¤šä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹
async def parallel_processing_example():
    initial_state: ChatState = {
        "user_input": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
        "llm_response": "",
        "search_results": "",
        "final_answer": ""
    }

    # å¹¶å‘æ‰§è¡Œ LLM å’Œæœç´¢
    print("ğŸš€ å¼€å§‹å¹¶å‘å¤„ç†...")
    start_time = time.time()

    llm_task = llm_node(initial_state)
    search_task = search_node(initial_state)

    # ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡å®Œæˆ
    llm_result, search_result = await asyncio.gather(llm_task, search_task)

    # åˆå¹¶ç»“æœ
    merged_state: ChatState = {
        "user_input": initial_state["user_input"],
        "llm_response": llm_result["llm_response"],
        "search_results": search_result["search_results"],
        "final_answer": ""
    }

    # æœ€åçš„ç»¼åˆå¤„ç†
    final_state = await synthesis_node(merged_state)

    end_time = time.time()
    print(f"â±ï¸ æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")
    print(f"ğŸ“ æœ€ç»ˆç»“æœ: {final_state['final_answer']}")

# è¿è¡Œç¤ºä¾‹
asyncio.run(parallel_processing_example())
```

## ğŸ”§ å®ç”¨å¼‚æ­¥æ¨¡å¼

### 1. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
import aiohttp
import asyncio

class AsyncLLMClient:
    """å¼‚æ­¥ LLM å®¢æˆ·ç«¯ç¤ºä¾‹"""

    def __init__(self, api_url: str):
        self.api_url = api_url
        self.session = None

    async def __aenter__(self):
        self.session = aiohttp.ClientSession()
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.session:
            await self.session.close()

    async def generate(self, prompt: str) -> str:
        """ç”Ÿæˆå“åº”"""
        # æ¨¡æ‹Ÿ API è°ƒç”¨
        await asyncio.sleep(1)
        return f"ç”Ÿæˆçš„å“åº”: {prompt}"

# ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
async def use_llm_client():
    async with AsyncLLMClient("https://api.example.com") as client:
        response = await client.generate("ä½ å¥½ï¼Œä¸–ç•Œï¼")
        print(response)
```

### 2. å¼‚æ­¥ç”Ÿæˆå™¨

```python
async def stream_responses(prompts: list[str]):
    """æµå¼å¤„ç†å¤šä¸ªæç¤º"""
    for prompt in prompts:
        await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
        yield f"å¤„ç†å®Œæˆ: {prompt}"

# ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨
async def process_stream():
    prompts = ["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"]

    async for response in stream_responses(prompts):
        print(f"ğŸ“¨ æ”¶åˆ°: {response}")
```

### 3. å¼‚æ­¥é˜Ÿåˆ—

```python
import asyncio
from asyncio import Queue

async def producer(queue: Queue, name: str):
    """ç”Ÿäº§è€…ï¼šæ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—"""
    for i in range(3):
        task = f"{name}-ä»»åŠ¡{i+1}"
        await queue.put(task)
        print(f"ğŸ­ {name} ç”Ÿäº§äº†: {task}")
        await asyncio.sleep(1)

async def consumer(queue: Queue, name: str):
    """æ¶ˆè´¹è€…ï¼šä»é˜Ÿåˆ—å¤„ç†ä»»åŠ¡"""
    while True:
        try:
            task = await asyncio.wait_for(queue.get(), timeout=5)
            print(f"ğŸ”§ {name} å¼€å§‹å¤„ç†: {task}")
            await asyncio.sleep(2)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
            print(f"âœ… {name} å®Œæˆäº†: {task}")
            queue.task_done()
        except asyncio.TimeoutError:
            print(f"â° {name} è¶…æ—¶é€€å‡º")
            break

# ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
async def producer_consumer_example():
    queue = Queue(maxsize=5)

    # å¯åŠ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
    producers = [
        asyncio.create_task(producer(queue, "ç”Ÿäº§è€…1")),
        asyncio.create_task(producer(queue, "ç”Ÿäº§è€…2"))
    ]

    consumers = [
        asyncio.create_task(consumer(queue, "æ¶ˆè´¹è€…1")),
        asyncio.create_task(consumer(queue, "æ¶ˆè´¹è€…2"))
    ]

    # ç­‰å¾…ç”Ÿäº§è€…å®Œæˆ
    await asyncio.gather(*producers)

    # ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    await queue.join()

    # å–æ¶ˆæ¶ˆè´¹è€…
    for c in consumers:
        c.cancel()

    print("ğŸ‰ æ‰€æœ‰ä»»åŠ¡å®Œæˆ!")

# è¿è¡Œç¤ºä¾‹
asyncio.run(producer_consumer_example())
```

## âš ï¸ å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

### 1. æ··åˆåŒæ­¥å’Œå¼‚æ­¥ä»£ç 

```python
import asyncio
import requests  # åŒæ­¥åº“

# âŒ é”™è¯¯ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨åŒæ­¥é˜»å¡æ“ä½œ
async def bad_example():
    response = requests.get("https://httpbin.org/delay/2")  # é˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯
    return response.json()

# âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼‚æ­¥HTTPå®¢æˆ·ç«¯
async def good_example():
    import aiohttp
    async with aiohttp.ClientSession() as session:
        async with session.get("https://httpbin.org/delay/2") as response:
            return await response.json()

# âœ… å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡ŒåŒæ­¥ä»£ç 
async def alternative_example():
    loop = asyncio.get_event_loop()
    # åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡ŒåŒæ­¥æ“ä½œ
    response = await loop.run_in_executor(
        None,
        lambda: requests.get("https://httpbin.org/delay/2")
    )
    return response.json()
```

### 2. å¿˜è®° await

```python
# âŒ é”™è¯¯ï¼šå¿˜è®° await
async def bad_awaiting():
    result = simulate_llm_call("é—®é¢˜")  # è¿”å› coroutine å¯¹è±¡ï¼Œä¸æ˜¯ç»“æœ
    print(result)  # æ‰“å° <coroutine object ...>

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ await
async def good_awaiting():
    result = await simulate_llm_call("é—®é¢˜")  # ç­‰å¾…ç»“æœ
    print(result)  # æ‰“å°å®é™…ç»“æœ
```

### 3. å¼‚å¸¸å¤„ç†

```python
async def safe_async_operation():
    """å®‰å…¨çš„å¼‚æ­¥æ“ä½œï¼ŒåŒ…å«å¼‚å¸¸å¤„ç†"""
    try:
        result = await simulate_llm_call("é—®é¢˜")
        return result
    except asyncio.TimeoutError:
        print("â° æ“ä½œè¶…æ—¶")
        return "é»˜è®¤å“åº”"
    except Exception as e:
        print(f"âŒ æ“ä½œå¤±è´¥: {e}")
        return "é”™è¯¯å“åº”"

# ä½¿ç”¨è¶…æ—¶ä¿æŠ¤
async def with_timeout():
    try:
        result = await asyncio.wait_for(
            simulate_llm_call("é—®é¢˜"),
            timeout=3.0
        )
        return result
    except asyncio.TimeoutError:
        return "æ“ä½œè¶…æ—¶ï¼Œè¿”å›é»˜è®¤å€¼"
```

## âœ… å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šå¼‚æ­¥æ•°æ®è·å–

```python
async def fetch_user_data(user_id: str) -> dict:
    """
    TODO: å®ç°å¼‚æ­¥è·å–ç”¨æˆ·æ•°æ®
    æ¨¡æ‹Ÿä»å¤šä¸ªæºè·å–æ•°æ®ï¼š
    - åŸºæœ¬ä¿¡æ¯ï¼ˆ1ç§’ï¼‰
    - åå¥½è®¾ç½®ï¼ˆ0.5ç§’ï¼‰
    - å†å²è®°å½•ï¼ˆ2ç§’ï¼‰
    è¦æ±‚ï¼šå¹¶å‘è·å–ï¼Œæ€»è€—æ—¶ä¸è¶…è¿‡2ç§’
    """
    pass

# æµ‹è¯•ä»£ç 
async def test_fetch_user_data():
    start = time.time()
    data = await fetch_user_data("user123")
    end = time.time()
    print(f"è·å–æ•°æ®è€—æ—¶: {end - start:.2f} ç§’")
    print(f"æ•°æ®: {data}")
```

<details>
<summary>ğŸ” æŸ¥çœ‹ç­”æ¡ˆ</summary>

```python
async def fetch_user_data(user_id: str) -> dict:
    """å¹¶å‘è·å–ç”¨æˆ·æ•°æ®"""

    async def get_basic_info():
        await asyncio.sleep(1)
        return {"name": "Alice", "age": 25}

    async def get_preferences():
        await asyncio.sleep(0.5)
        return {"theme": "dark", "language": "zh"}

    async def get_history():
        await asyncio.sleep(2)
        return {"last_login": "2024-01-01", "login_count": 42}

    # å¹¶å‘æ‰§è¡Œ
    basic, prefs, history = await asyncio.gather(
        get_basic_info(),
        get_preferences(),
        get_history()
    )

    return {
        "user_id": user_id,
        "basic_info": basic,
        "preferences": prefs,
        "history": history
    }
```
</details>

### ç»ƒä¹  2ï¼šå¼‚æ­¥ LangGraph èŠ‚ç‚¹

```python
from typing import TypedDict, List

class ResearchState(TypedDict):
    query: str
    web_results: List[str]
    paper_results: List[str]
    summary: str

async def web_search_node(state: ResearchState) -> ResearchState:
    """TODO: å®ç°å¼‚æ­¥ç½‘ç»œæœç´¢èŠ‚ç‚¹"""
    pass

async def paper_search_node(state: ResearchState) -> ResearchState:
    """TODO: å®ç°å¼‚æ­¥è®ºæ–‡æœç´¢èŠ‚ç‚¹"""
    pass

async def summarize_node(state: ResearchState) -> ResearchState:
    """TODO: å®ç°å¼‚æ­¥æ€»ç»“èŠ‚ç‚¹"""
    pass

# ç ”ç©¶æµç¨‹
async def research_pipeline(query: str):
    """TODO: å®ç°å®Œæ•´çš„ç ”ç©¶æµç¨‹"""
    pass
```

## ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ 

æŒæ¡å¼‚æ­¥ç¼–ç¨‹åï¼Œæ¥ä¸‹æ¥å­¦ä¹ ï¼š
- `04-è£…é¥°å™¨ä¸é«˜é˜¶å‡½æ•°.md` - å‡½æ•°å¼ç¼–ç¨‹åœ¨ LangGraph ä¸­çš„åº”ç”¨
- `../02-å›¾è®ºä¸çŠ¶æ€æœº/01-å›¾çš„åŸºæœ¬æ¦‚å¿µ.md` - ç†è§£ LangGraph çš„æ•°å­¦åŸºç¡€

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **å¼‚æ­¥æå‡æ€§èƒ½**ï¼šé€šè¿‡å¹¶å‘æ‰§è¡Œå‡å°‘ç­‰å¾…æ—¶é—´
2. **LangGraph åŸç”Ÿæ”¯æŒ**ï¼šèŠ‚ç‚¹å‡½æ•°å¯ä»¥æ˜¯å¼‚æ­¥çš„
3. **é¿å…é˜»å¡**ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­é¿å…åŒæ­¥é˜»å¡æ“ä½œ
4. **é”™è¯¯å¤„ç†**ï¼šå¼‚æ­¥ä»£ç éœ€è¦ç‰¹åˆ«æ³¨æ„å¼‚å¸¸å’Œè¶…æ—¶å¤„ç†
5. **å·¥å…·é€‰æ‹©**ï¼šä½¿ç”¨å¼‚æ­¥åº“ï¼ˆå¦‚ aiohttpï¼‰è€Œä¸æ˜¯åŒæ­¥åº“

---

*ç°åœ¨ä½ å·²ç»æŒæ¡äº†ç°ä»£ Python åº”ç”¨å¼€å‘çš„æ ¸å¿ƒæŠ€èƒ½ï¼* ğŸš€