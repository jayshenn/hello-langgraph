# 01-æ¡ä»¶è·¯ç”±è¯¦è§£

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š
- LangGraph ä¸­æ¡ä»¶è·¯ç”±çš„é«˜çº§ç”¨æ³•
- è®¾è®¡å¤æ‚çš„è·¯ç”±å‡½æ•°
- å®ç°å¤šæ¡ä»¶ç»„åˆè·¯ç”±
- åŠ¨æ€è·¯ç”±ç­–ç•¥çš„åº”ç”¨åœºæ™¯

## ğŸ“š å‰ç½®çŸ¥è¯†å›é¡¾

åœ¨å¼€å§‹è¿›é˜¶å†…å®¹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹åŸºç¡€çš„æ¡ä»¶è·¯ç”±ï¼š

```python
# åŸºç¡€æ¡ä»¶è·¯ç”±ï¼ˆæ¥è‡ª Graph IVï¼‰
graph.add_conditional_edges(
    "source_node",
    condition_function,  # è¿”å›å­—ç¬¦ä¸²é”®
    {
        "condition_result": "target_node",
        "other_result": END
    }
)
```

## ğŸ” æ¡ä»¶è·¯ç”±çš„æœ¬è´¨

### è·¯ç”±å‡½æ•°çš„å·¥ä½œåŸç†

æ¡ä»¶è·¯ç”±æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**å†³ç­–æ ‘**ï¼Œè·¯ç”±å‡½æ•°è´Ÿè´£ï¼š
1. **æ¥æ”¶å½“å‰çŠ¶æ€**ï¼šåˆ†æ `AgentState` ä¸­çš„æ•°æ®
2. **æ‰§è¡Œå†³ç­–é€»è¾‘**ï¼šåŸºäºä¸šåŠ¡è§„åˆ™åšåˆ¤æ–­
3. **è¿”å›è·¯ç”±é”®**ï¼šæŒ‡ç¤ºä¸‹ä¸€æ­¥æ‰§è¡Œçš„èŠ‚ç‚¹

```python
def route_function(state: AgentState) -> str:
    """
    è·¯ç”±å‡½æ•°å¿…é¡»ï¼š
    1. æ¥æ”¶ state å‚æ•°
    2. è¿”å›å­—ç¬¦ä¸²ï¼ˆå¯¹åº”æ˜ å°„è¡¨ä¸­çš„é”®ï¼‰
    3. é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºè°ƒè¯•
    """
    # åˆ†æçŠ¶æ€
    user_input = state.get("user_input", "")
    confidence = state.get("confidence", 0.0)

    # å†³ç­–é€»è¾‘
    if confidence > 0.8:
        return "high_confidence"
    elif confidence > 0.5:
        return "medium_confidence"
    else:
        return "low_confidence"
```

## ğŸ¨ é«˜çº§è·¯ç”±æ¨¡å¼

### 1. å¤šå±‚æ¡ä»¶è·¯ç”±

å½“å•ä¸€æ¡ä»¶ä¸è¶³ä»¥åšå†³ç­–æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¤šå±‚æ¡ä»¶ï¼š

```python
def complex_router(state: AgentState) -> str:
    """å¤æ‚çš„å¤šå±‚æ¡ä»¶è·¯ç”±"""
    message_type = state.get("message_type")
    user_intent = state.get("user_intent")
    context_available = state.get("has_context", False)

    # ç¬¬ä¸€å±‚ï¼šæŒ‰æ¶ˆæ¯ç±»å‹åˆ†ç±»
    if message_type == "query":
        # ç¬¬äºŒå±‚ï¼šæŒ‰æ„å›¾ç»†åˆ†
        if user_intent == "information_seeking":
            return "search_knowledge" if context_available else "gather_context"
        elif user_intent == "task_execution":
            return "execute_task"
        else:
            return "clarify_intent"

    elif message_type == "feedback":
        return "process_feedback"

    else:
        return "default_handler"

# ä½¿ç”¨å¤šå±‚è·¯ç”±
graph.add_conditional_edges(
    "classifier",
    complex_router,
    {
        "search_knowledge": "knowledge_search",
        "gather_context": "context_gathering",
        "execute_task": "task_executor",
        "clarify_intent": "intent_clarifier",
        "process_feedback": "feedback_processor",
        "default_handler": "fallback_node"
    }
)
```

### 2. æ¦‚ç‡æ€§è·¯ç”±

åŸºäºç½®ä¿¡åº¦æˆ–æ¦‚ç‡è¿›è¡ŒåŠ¨æ€è·¯ç”±ï¼š

```python
import random

def probability_router(state: AgentState) -> str:
    """åŸºäºæ¦‚ç‡çš„è·¯ç”±å†³ç­–"""
    predictions = state.get("model_predictions", {})

    # è·å–æœ€é«˜ç½®ä¿¡åº¦çš„é¢„æµ‹
    if not predictions:
        return "fallback"

    best_prediction = max(predictions.items(), key=lambda x: x[1])
    confidence = best_prediction[1]

    # åŸºäºç½®ä¿¡åº¦çš„è·¯ç”±ç­–ç•¥
    if confidence > 0.9:
        return "direct_answer"
    elif confidence > 0.7:
        return "verify_answer"
    elif confidence > 0.4:
        # ä¸­ç­‰ç½®ä¿¡åº¦ï¼Œè€ƒè™‘å¤šç§ç­–ç•¥
        strategies = ["search_more", "ask_human", "use_fallback"]
        weights = [0.5, 0.3, 0.2]
        return random.choices(strategies, weights=weights)[0]
    else:
        return "request_clarification"
```

### 3. çŠ¶æ€å†å²è·¯ç”±

åŸºäºèŠ‚ç‚¹æ‰§è¡Œå†å²åšå†³ç­–ï¼š

```python
def history_aware_router(state: AgentState) -> str:
    """æ„ŸçŸ¥å†å²çŠ¶æ€çš„è·¯ç”±"""
    execution_history = state.get("execution_history", [])
    current_attempts = state.get("retry_count", 0)
    last_error = state.get("last_error")

    # é¿å…æ— é™å¾ªç¯
    if current_attempts >= 3:
        return "escalate_to_human"

    # åŸºäºå†å²é€‰æ‹©ç­–ç•¥
    if "search_failed" in execution_history:
        if "alternative_search" not in execution_history:
            return "alternative_search"
        else:
            return "manual_research"

    # åŸºäºé”™è¯¯ç±»å‹è·¯ç”±
    if last_error:
        if "network" in str(last_error).lower():
            return "retry_with_backoff"
        elif "permission" in str(last_error).lower():
            return "request_permission"
        else:
            return "error_analysis"

    return "continue_normal_flow"
```

## ğŸ”§ åŠ¨æ€è·¯ç”±æ˜ å°„

### è¿è¡Œæ—¶è·¯ç”±æ„å»º

æœ‰æ—¶è·¯ç”±æ˜ å°„éœ€è¦æ ¹æ®çŠ¶æ€åŠ¨æ€æ„å»ºï¼š

```python
def build_dynamic_routes(state: AgentState) -> Dict[str, str]:
    """åŠ¨æ€æ„å»ºè·¯ç”±æ˜ å°„"""
    available_tools = state.get("available_tools", [])
    user_preferences = state.get("user_preferences", {})

    routes = {"fallback": "default_node"}

    # æ ¹æ®å¯ç”¨å·¥å…·åŠ¨æ€æ·»åŠ è·¯ç”±
    for tool in available_tools:
        if tool == "web_search" and user_preferences.get("allow_web", True):
            routes["need_search"] = "web_search_node"
        elif tool == "database" and user_preferences.get("allow_db", True):
            routes["need_data"] = "database_node"
        elif tool == "calculator":
            routes["need_calculation"] = "calculator_node"

    return routes

# åœ¨å›¾æ„å»ºæ—¶ä½¿ç”¨åŠ¨æ€è·¯ç”±
def smart_conditional_edges(graph, source_node, route_func, state_sample):
    """æ™ºèƒ½æ¡ä»¶è¾¹æ·»åŠ """
    # ä½¿ç”¨ç¤ºä¾‹çŠ¶æ€æ„å»ºåˆå§‹è·¯ç”±
    initial_routes = build_dynamic_routes(state_sample)

    graph.add_conditional_edges(
        source_node,
        route_func,
        initial_routes
    )
```

## ğŸš€ æœ€ä½³å®è·µ

### 1. è·¯ç”±å‡½æ•°è®¾è®¡åŸåˆ™

```python
def well_designed_router(state: AgentState) -> str:
    """è®¾è®¡è‰¯å¥½çš„è·¯ç”±å‡½æ•°ç¤ºä¾‹"""

    # âœ… å¥½çš„å®è·µï¼š
    # 1. æ˜ç¡®çš„é»˜è®¤åˆ†æ”¯
    default_route = "fallback"

    # 2. ç©ºå€¼æ£€æŸ¥
    if not state:
        return default_route

    # 3. æ¸…æ™°çš„æ¡ä»¶é€»è¾‘
    user_query = state.get("user_query", "").lower().strip()
    if not user_query:
        return "request_input"

    # 4. å¯é…ç½®çš„é˜ˆå€¼
    similarity_threshold = state.get("config", {}).get("similarity_threshold", 0.7)

    # 5. è¯¦ç»†çš„æ—¥å¿—
    import logging
    logger = logging.getLogger(__name__)

    # 6. å¼‚å¸¸å¤„ç†
    try:
        similarity_score = calculate_similarity(user_query, state.get("context", ""))

        if similarity_score > similarity_threshold:
            logger.info(f"High similarity route chosen: {similarity_score}")
            return "contextual_response"
        else:
            logger.info(f"General route chosen: {similarity_score}")
            return "general_response"

    except Exception as e:
        logger.error(f"Router error: {e}")
        return default_route

def calculate_similarity(query: str, context: str) -> float:
    """è®¡ç®—ç›¸ä¼¼åº¦çš„è¾…åŠ©å‡½æ•°"""
    # è¿™é‡Œå¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„ç›¸ä¼¼åº¦ç®—æ³•
    if not query or not context:
        return 0.0
    return len(set(query.split()) & set(context.split())) / len(set(query.split()))
```

### 2. è°ƒè¯•æ¡ä»¶è·¯ç”±

```python
def debug_router(state: AgentState) -> str:
    """å¸¦è°ƒè¯•åŠŸèƒ½çš„è·¯ç”±å‡½æ•°"""
    debug_info = {
        "input_state": dict(state),
        "timestamp": datetime.now().isoformat(),
        "route_decision": None,
        "decision_factors": {}
    }

    try:
        # å†³ç­–é€»è¾‘
        user_input = state.get("user_input", "")
        intent_confidence = state.get("intent_confidence", 0.0)

        debug_info["decision_factors"] = {
            "user_input_length": len(user_input),
            "intent_confidence": intent_confidence,
            "has_context": bool(state.get("context"))
        }

        if intent_confidence > 0.8:
            route = "high_confidence_path"
        elif len(user_input) > 100:
            route = "detailed_analysis_path"
        else:
            route = "standard_path"

        debug_info["route_decision"] = route

        # ä¿å­˜è°ƒè¯•ä¿¡æ¯åˆ°çŠ¶æ€
        if "debug_history" not in state:
            state["debug_history"] = []
        state["debug_history"].append(debug_info)

        return route

    except Exception as e:
        debug_info["error"] = str(e)
        state.setdefault("debug_history", []).append(debug_info)
        return "error_path"
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. è·¯ç”±å‡½æ•°æ€§èƒ½

```python
import functools
import time

def performance_monitored_router(state: AgentState) -> str:
    """æ€§èƒ½ç›‘æ§çš„è·¯ç”±å‡½æ•°"""
    start_time = time.time()

    # ç¼“å­˜æ˜‚è´µçš„è®¡ç®—
    @functools.lru_cache(maxsize=128)
    def expensive_calculation(input_text: str) -> float:
        # æ¨¡æ‹Ÿæ˜‚è´µçš„è®¡ç®—ï¼ˆå¦‚ NLP å¤„ç†ï¼‰
        time.sleep(0.1)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
        return len(input_text) / 100.0

    try:
        user_input = state.get("user_input", "")

        # ä½¿ç”¨ç¼“å­˜çš„è®¡ç®—ç»“æœ
        score = expensive_calculation(user_input)

        route = "complex_path" if score > 0.5 else "simple_path"

        # è®°å½•æ€§èƒ½æŒ‡æ ‡
        execution_time = time.time() - start_time
        if execution_time > 0.5:  # è¶…è¿‡500msè®°å½•è­¦å‘Š
            import logging
            logging.warning(f"Router execution time: {execution_time:.3f}s")

        return route

    except Exception as e:
        return "error_path"
```

### 2. é¿å…è·¯ç”±æ­»é”

```python
def deadlock_safe_router(state: AgentState) -> str:
    """é˜²æ­¢æ­»é”çš„è·¯ç”±å‡½æ•°"""

    # æ£€æŸ¥å¾ªç¯è®¡æ•°
    node_visit_count = state.get("node_visit_count", {})
    current_node = state.get("current_node", "unknown")

    # æ›´æ–°è®¿é—®è®¡æ•°
    node_visit_count[current_node] = node_visit_count.get(current_node, 0) + 1
    state["node_visit_count"] = node_visit_count

    # æ£€æµ‹æ½œåœ¨çš„æ— é™å¾ªç¯
    max_visits = 5
    if node_visit_count.get(current_node, 0) > max_visits:
        # å¼ºåˆ¶é€€å‡ºå¾ªç¯
        return "exit_loop"

    # æ£€æŸ¥æ€»çš„èŠ‚ç‚¹è®¿é—®æ¬¡æ•°
    total_visits = sum(node_visit_count.values())
    if total_visits > 50:  # æ€»è®¿é—®æ¬¡æ•°é™åˆ¶
        return "force_exit"

    # æ­£å¸¸çš„è·¯ç”±é€»è¾‘
    user_intent = state.get("user_intent", "")

    if user_intent == "continue":
        return "next_step"
    elif user_intent == "retry":
        # é™åˆ¶é‡è¯•æ¬¡æ•°
        if node_visit_count.get("retry_node", 0) < 3:
            return "retry_node"
        else:
            return "give_up"
    else:
        return "default_next"
```

## ğŸ® å®è·µç»ƒä¹ 

### ç»ƒä¹  1ï¼šæ™ºèƒ½å®¢æœè·¯ç”±å™¨

è®¾è®¡ä¸€ä¸ªæ™ºèƒ½å®¢æœç³»ç»Ÿçš„è·¯ç”±å™¨ï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·é—®é¢˜çš„ç±»å‹ã€ç´§æ€¥ç¨‹åº¦å’Œç”¨æˆ·ç­‰çº§è¿›è¡Œè·¯ç”±ï¼š

```python
def customer_service_router(state: AgentState) -> str:
    """
    ç»ƒä¹ ï¼šå®ç°å®¢æœè·¯ç”±é€»è¾‘

    è·¯ç”±è§„åˆ™ï¼š
    1. VIPç”¨æˆ· -> ä¸“å±æœåŠ¡
    2. ç´§æ€¥é—®é¢˜ -> ä¼˜å…ˆå¤„ç†
    3. æŠ€æœ¯é—®é¢˜ -> æŠ€æœ¯æ”¯æŒ
    4. è´¦å•é—®é¢˜ -> è´¢åŠ¡éƒ¨é—¨
    5. å…¶ä»– -> é€šç”¨å®¢æœ
    """
    # TODO: å®ç°ä½ çš„è·¯ç”±é€»è¾‘
    pass
```

### ç»ƒä¹  2ï¼šå¤šæ¨¡æ€å†…å®¹è·¯ç”±

åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿå¤„ç†æ–‡æœ¬ã€å›¾ç‰‡ã€éŸ³é¢‘çš„å¤šæ¨¡æ€è·¯ç”±å™¨ï¼š

```python
def multimodal_router(state: AgentState) -> str:
    """
    ç»ƒä¹ ï¼šå®ç°å¤šæ¨¡æ€è·¯ç”±

    éœ€è¦å¤„ç†ï¼š
    - æ–‡æœ¬æ¶ˆæ¯
    - å›¾ç‰‡åˆ†æ
    - éŸ³é¢‘è½¬æ–‡æœ¬
    - ç»„åˆå†…å®¹
    """
    # TODO: å®ç°ä½ çš„è·¯ç”±é€»è¾‘
    pass
```

## ğŸ”— ä¸åç»­ç« èŠ‚çš„è”ç³»

æ¡ä»¶è·¯ç”±æ˜¯ LangGraph çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œå®ƒä¸ºåç»­çš„é«˜çº§ç‰¹æ€§æä¾›äº†åŸºç¡€ï¼š

- **å¾ªç¯ç»“æ„**ï¼šéœ€è¦æ¡ä»¶è·¯ç”±æ¥æ§åˆ¶å¾ªç¯çš„ç»§ç»­æˆ–é€€å‡º
- **Human-in-the-Loop**ï¼šä½¿ç”¨æ¡ä»¶è·¯ç”±å†³å®šä½•æ—¶éœ€è¦äººå·¥å¹²é¢„
- **å­å›¾é€šä¿¡**ï¼šæ¡ä»¶è·¯ç”±æ§åˆ¶å­å›¾ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’

## ğŸ“š æ¨èé˜…è¯»

- [LangGraph å®˜æ–¹æ–‡æ¡£ - Conditional Edges](https://langchain-ai.github.io/langgraph/how-tos/graph-api/)
- é¡¹ç›®ç¤ºä¾‹ï¼š`Graphs/04-Conditional.ipynb`
- ç»ƒä¹ ï¼š`Exercises/Exercise_Graph4.ipynb`

---

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼šåœ¨æŒæ¡äº†é«˜çº§æ¡ä»¶è·¯ç”±åï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•è®¾è®¡å®‰å…¨é«˜æ•ˆçš„å¾ªç¯ç»“æ„ï¼Œé¿å…æ— é™å¾ªç¯é™·é˜±ã€‚