# çŠ¶æ€æœºåŸç†

> ğŸ¯ **å­¦ä¹ ç›®æ ‡**ï¼šç†è§£æœ‰é™çŠ¶æ€æœºï¼ˆFSMï¼‰çš„å·¥ä½œåŸç†ï¼ŒæŒæ¡ LangGraph çš„çŠ¶æ€ç®¡ç†æ ¸å¿ƒæ€æƒ³

## ğŸ¤– ä»€ä¹ˆæ˜¯çŠ¶æ€æœºï¼Ÿ

çŠ¶æ€æœºæ˜¯ä¸€ä¸ªæ•°å­¦æ¨¡å‹ï¼Œç”¨æ¥æè¿°ç³»ç»Ÿåœ¨ä¸åŒçŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚æƒ³è±¡ä¸€ä¸‹ï¼š

### ç”Ÿæ´»ä¸­çš„çŠ¶æ€æœº - ç”µç¯å¼€å…³

```
å…³é—­çŠ¶æ€ â€”â€”[æŒ‰ä¸‹å¼€å…³]â€”â€”â†’ å¼€å¯çŠ¶æ€
    â†‘                        â†“
    â†â€”â€”â€”â€”â€”â€”[æŒ‰ä¸‹å¼€å…³]â€”â€”â€”â€”â€”â€”â€”â€”â€”
```

è¿™ä¸ªç®€å•çš„ç”µç¯å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼š
- **çŠ¶æ€**ï¼šå…³é—­ã€å¼€å¯
- **äº‹ä»¶**ï¼šæŒ‰ä¸‹å¼€å…³
- **è½¬æ¢**ï¼šçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢

## ğŸ—ï¸ çŠ¶æ€æœºçš„ç»„æˆè¦ç´ 

### 1. çŠ¶æ€ï¼ˆStateï¼‰

```python
# èŠå¤©æœºå™¨äººçš„çŠ¶æ€
class ChatbotStates:
    WAITING_INPUT = "waiting_input"      # ç­‰å¾…ç”¨æˆ·è¾“å…¥
    PROCESSING = "processing"            # å¤„ç†ä¸­
    GENERATING_RESPONSE = "generating"   # ç”Ÿæˆå“åº”
    COMPLETED = "completed"              # å®Œæˆ
    ERROR = "error"                      # é”™è¯¯çŠ¶æ€
```

### 2. äº‹ä»¶ï¼ˆEventï¼‰/è§¦å‘å™¨

```python
# çŠ¶æ€è½¬æ¢çš„è§¦å‘äº‹ä»¶
class ChatbotEvents:
    USER_INPUT_RECEIVED = "user_input"
    PROCESSING_COMPLETE = "processed"
    RESPONSE_GENERATED = "response_ready"
    ERROR_OCCURRED = "error"
    RESET = "reset"
```

### 3. è½¬æ¢ï¼ˆTransitionï¼‰

```python
# çŠ¶æ€è½¬æ¢è§„åˆ™
state_transitions = {
    (ChatbotStates.WAITING_INPUT, ChatbotEvents.USER_INPUT_RECEIVED): ChatbotStates.PROCESSING,
    (ChatbotStates.PROCESSING, ChatbotEvents.PROCESSING_COMPLETE): ChatbotStates.GENERATING_RESPONSE,
    (ChatbotStates.GENERATING_RESPONSE, ChatbotEvents.RESPONSE_GENERATED): ChatbotStates.COMPLETED,
    (ChatbotStates.COMPLETED, ChatbotEvents.RESET): ChatbotStates.WAITING_INPUT,
    # é”™è¯¯å¤„ç†
    (ChatbotStates.PROCESSING, ChatbotEvents.ERROR_OCCURRED): ChatbotStates.ERROR,
    (ChatbotStates.ERROR, ChatbotEvents.RESET): ChatbotStates.WAITING_INPUT,
}
```

## ğŸ¯ LangGraph ä¸­çš„çŠ¶æ€æœº

### ä¼ ç»ŸçŠ¶æ€æœº vs LangGraph çŠ¶æ€æœº

**ä¼ ç»ŸçŠ¶æ€æœºï¼š**
```python
class TraditionalStateMachine:
    def __init__(self):
        self.current_state = "START"
        self.data = {}  # ç®€å•çš„æ•°æ®å­˜å‚¨

    def transition(self, event):
        # ç®€å•çš„çŠ¶æ€åˆ‡æ¢
        if self.current_state == "START" and event == "begin":
            self.current_state = "PROCESSING"
```

**LangGraph çŠ¶æ€æœºï¼š**
```python
from typing import TypedDict
from langgraph.graph import StateGraph

class AgentState(TypedDict):
    # ä¸°å¯Œçš„çŠ¶æ€ä¿¡æ¯
    user_input: str
    conversation_history: list[str]
    current_step: str
    tool_results: dict
    confidence_score: float

def input_handler(state: AgentState) -> AgentState:
    """å¤„ç†è¾“å…¥çš„èŠ‚ç‚¹ - ä¸åªæ˜¯çŠ¶æ€åˆ‡æ¢ï¼Œè¿˜æœ‰æ•°æ®å¤„ç†"""
    return {
        **state,
        "current_step": "processing",
        "conversation_history": state["conversation_history"] + [state["user_input"]]
    }
```

### LangGraph çŠ¶æ€ç®¡ç†çš„ç‰¹ç‚¹

1. **å¯ŒçŠ¶æ€ï¼ˆRich Stateï¼‰**ï¼šä¸åªæ˜¯ç®€å•çš„çŠ¶æ€æ ‡è¯†ï¼ŒåŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
2. **çŠ¶æ€ + æ•°æ®**ï¼šæ¯ä¸ªçŠ¶æ€éƒ½æºå¸¦ä¸°å¯Œçš„æ•°æ®
3. **ä¸å¯å˜æ›´æ–°**ï¼šæ¯æ¬¡çŠ¶æ€è½¬æ¢éƒ½äº§ç”Ÿæ–°çš„çŠ¶æ€å¯¹è±¡

## ğŸ”„ çŠ¶æ€è½¬æ¢æ¨¡å¼

### 1. é¡ºåºè½¬æ¢

```python
class SequentialState(TypedDict):
    step: int
    message: str
    data: list[str]

def step1(state: SequentialState) -> SequentialState:
    return {
        **state,
        "step": 1,
        "message": "å®Œæˆæ­¥éª¤1",
        "data": state["data"] + ["æ­¥éª¤1å®Œæˆ"]
    }

def step2(state: SequentialState) -> SequentialState:
    return {
        **state,
        "step": 2,
        "message": "å®Œæˆæ­¥éª¤2",
        "data": state["data"] + ["æ­¥éª¤2å®Œæˆ"]
    }

# å›¾æ„å»º
graph = StateGraph(SequentialState)
graph.add_node("step1", step1)
graph.add_node("step2", step2)
graph.add_edge("step1", "step2")  # é¡ºåºè½¬æ¢
```

### 2. æ¡ä»¶è½¬æ¢

```python
class ConditionalState(TypedDict):
    user_type: str
    age: int
    access_granted: bool

def age_checker(state: ConditionalState) -> ConditionalState:
    """æ£€æŸ¥å¹´é¾„"""
    return {
        **state,
        "access_granted": state["age"] >= 18
    }

def route_by_access(state: ConditionalState) -> str:
    """æ ¹æ®è®¿é—®æƒé™è·¯ç”±"""
    if state["access_granted"]:
        return "adult_content"
    else:
        return "restricted_content"

def adult_content(state: ConditionalState) -> ConditionalState:
    return {**state, "user_type": "æˆå¹´ç”¨æˆ·"}

def restricted_content(state: ConditionalState) -> ConditionalState:
    return {**state, "user_type": "æœªæˆå¹´ç”¨æˆ·"}

# å›¾æ„å»º
graph = StateGraph(ConditionalState)
graph.add_node("check_age", age_checker)
graph.add_node("adult_content", adult_content)
graph.add_node("restricted_content", restricted_content)

graph.add_conditional_edges(
    "check_age",
    route_by_access,
    {
        "adult_content": "adult_content",
        "restricted_content": "restricted_content"
    }
)
```

### 3. å¾ªç¯è½¬æ¢

```python
class LoopState(TypedDict):
    attempts: int
    max_attempts: int
    success: bool
    result: str

def try_operation(state: LoopState) -> LoopState:
    """å°è¯•æ‰§è¡Œæ“ä½œ"""
    import random

    success = random.random() > 0.5  # 50% æˆåŠŸç‡
    attempts = state["attempts"] + 1

    return {
        **state,
        "attempts": attempts,
        "success": success,
        "result": "æˆåŠŸ" if success else f"å¤±è´¥ (å°è¯• {attempts})"
    }

def should_continue(state: LoopState) -> str:
    """å†³å®šæ˜¯å¦ç»§ç»­å¾ªç¯"""
    if state["success"]:
        return "end"
    elif state["attempts"] >= state["max_attempts"]:
        return "end"
    else:
        return "try_again"

# å›¾æ„å»ºï¼ˆæ”¯æŒå¾ªç¯ï¼‰
graph = StateGraph(LoopState)
graph.add_node("try_operation", try_operation)

graph.set_entry_point("try_operation")
graph.add_conditional_edges(
    "try_operation",
    should_continue,
    {
        "try_again": "try_operation",  # å¾ªç¯å›è‡ªå·±
        "end": END
    }
)
```

## ğŸª å¤æ‚çŠ¶æ€æœºç¤ºä¾‹ï¼šæ™ºèƒ½å®¢æœ

è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ™ºèƒ½å®¢æœçš„çŠ¶æ€æœºï¼š

```python
from typing import TypedDict, Literal

class CustomerServiceState(TypedDict):
    # ç”¨æˆ·ä¿¡æ¯
    user_message: str
    user_id: str
    session_id: str

    # å¯¹è¯çŠ¶æ€
    current_stage: Literal["greeting", "intent_analysis", "handling", "escalation", "closing"]
    intent: str
    confidence: float

    # å¤„ç†ä¿¡æ¯
    conversation_history: list[str]
    solution_attempts: int
    escalated: bool
    satisfaction_score: int

def greeting_handler(state: CustomerServiceState) -> CustomerServiceState:
    """å¤„ç†é—®å€™é˜¶æ®µ"""
    greeting_msg = f"æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚"

    return {
        **state,
        "current_stage": "intent_analysis",
        "conversation_history": state["conversation_history"] + [
            f"ç”¨æˆ·: {state['user_message']}",
            f"å®¢æœ: {greeting_msg}"
        ]
    }

def intent_analyzer(state: CustomerServiceState) -> CustomerServiceState:
    """åˆ†æç”¨æˆ·æ„å›¾"""
    message = state["user_message"].lower()

    # ç®€å•çš„æ„å›¾è¯†åˆ«
    if any(word in message for word in ["é€€æ¬¾", "é€€è´§", "è¿”å›"]):
        intent = "refund"
        confidence = 0.8
    elif any(word in message for word in ["è®¢å•", "çŠ¶æ€", "æŸ¥è¯¢"]):
        intent = "order_inquiry"
        confidence = 0.9
    elif any(word in message for word in ["æŠ€æœ¯", "é—®é¢˜", "æ•…éšœ"]):
        intent = "technical_support"
        confidence = 0.7
    else:
        intent = "general_inquiry"
        confidence = 0.5

    return {
        **state,
        "current_stage": "handling",
        "intent": intent,
        "confidence": confidence
    }

def issue_handler(state: CustomerServiceState) -> CustomerServiceState:
    """å¤„ç†å…·ä½“é—®é¢˜"""
    intent = state["intent"]
    solution_attempts = state["solution_attempts"] + 1

    if intent == "refund":
        response = "æˆ‘æ¥å¸®æ‚¨å¤„ç†é€€æ¬¾ç”³è¯·..."
    elif intent == "order_inquiry":
        response = "è®©æˆ‘æŸ¥è¯¢æ‚¨çš„è®¢å•çŠ¶æ€..."
    elif intent == "technical_support":
        response = "æˆ‘æ¥å¸®æ‚¨è§£å†³æŠ€æœ¯é—®é¢˜..."
    else:
        response = "æˆ‘éœ€è¦äº†è§£æ›´å¤šä¿¡æ¯æ¥å¸®åŠ©æ‚¨..."

    return {
        **state,
        "current_stage": "closing",
        "solution_attempts": solution_attempts,
        "conversation_history": state["conversation_history"] + [f"å®¢æœ: {response}"]
    }

def escalation_checker(state: CustomerServiceState) -> str:
    """æ£€æŸ¥æ˜¯å¦éœ€è¦äººå·¥å®¢æœ"""
    if state["confidence"] < 0.6:
        return "escalate"
    elif state["solution_attempts"] >= 3:
        return "escalate"
    else:
        return "handle"

def human_escalation(state: CustomerServiceState) -> CustomerServiceState:
    """è½¬äººå·¥å®¢æœ"""
    return {
        **state,
        "current_stage": "escalation",
        "escalated": True,
        "conversation_history": state["conversation_history"] + [
            "å®¢æœ: æˆ‘å°†ä¸ºæ‚¨è½¬æ¥äººå·¥å®¢æœï¼Œè¯·ç¨ç­‰..."
        ]
    }

# æ„å»ºå®¢æœçŠ¶æ€æœº
graph = StateGraph(CustomerServiceState)

# æ·»åŠ èŠ‚ç‚¹
graph.add_node("greeting", greeting_handler)
graph.add_node("analyze_intent", intent_analyzer)
graph.add_node("handle_issue", issue_handler)
graph.add_node("escalate", human_escalation)

# è®¾ç½®æµç¨‹
graph.set_entry_point("greeting")
graph.add_edge("greeting", "analyze_intent")

graph.add_conditional_edges(
    "analyze_intent",
    escalation_checker,
    {
        "handle": "handle_issue",
        "escalate": "escalate"
    }
)

graph.add_edge("handle_issue", END)
graph.add_edge("escalate", END)

# ç¼–è¯‘å’Œä½¿ç”¨
customer_service = graph.compile()

# æµ‹è¯•
initial_state = {
    "user_message": "æˆ‘è¦é€€æ¬¾",
    "user_id": "user123",
    "session_id": "session456",
    "current_stage": "greeting",
    "intent": "",
    "confidence": 0.0,
    "conversation_history": [],
    "solution_attempts": 0,
    "escalated": False,
    "satisfaction_score": 0
}

result = customer_service.invoke(initial_state)
print(f"æœ€ç»ˆçŠ¶æ€: {result['current_stage']}")
print(f"å¯¹è¯å†å²: {result['conversation_history']}")
```

## ğŸ” çŠ¶æ€æœºè°ƒè¯•æŠ€å·§

### 1. çŠ¶æ€è¿½è¸ª

```python
def trace_state_changes(old_state: dict, new_state: dict, node_name: str):
    """è¿½è¸ªçŠ¶æ€å˜åŒ–"""
    print(f"\nğŸ”„ èŠ‚ç‚¹ '{node_name}' æ‰§è¡Œå®Œæˆ:")

    for key in set(old_state.keys()) | set(new_state.keys()):
        old_val = old_state.get(key, "<MISSING>")
        new_val = new_state.get(key, "<MISSING>")

        if old_val != new_val:
            print(f"  ğŸ“ {key}: {old_val} â†’ {new_val}")

# åœ¨èŠ‚ç‚¹ä¸­ä½¿ç”¨
def traced_node(state: AgentState) -> AgentState:
    old_state = state.copy()
    # ... å¤„ç†é€»è¾‘ ...
    new_state = {...}
    trace_state_changes(old_state, new_state, "traced_node")
    return new_state
```

### 2. çŠ¶æ€éªŒè¯

```python
def validate_state_transition(state: dict, expected_fields: list[str]) -> bool:
    """éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦æœ‰æ•ˆ"""
    for field in expected_fields:
        if field not in state:
            print(f"âŒ ç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
            return False

    return True

def safe_node(state: AgentState) -> AgentState:
    """å¸¦éªŒè¯çš„å®‰å…¨èŠ‚ç‚¹"""
    # éªŒè¯è¾“å…¥çŠ¶æ€
    if not validate_state_transition(state, ["user_input", "conversation_history"]):
        raise ValueError("è¾“å…¥çŠ¶æ€æ— æ•ˆ")

    # å¤„ç†é€»è¾‘
    new_state = {...}

    # éªŒè¯è¾“å‡ºçŠ¶æ€
    if not validate_state_transition(new_state, ["current_step", "conversation_history"]):
        raise ValueError("è¾“å‡ºçŠ¶æ€æ— æ•ˆ")

    return new_state
```

## âœ… å®è·µç»ƒä¹ 

### ç»ƒä¹  1ï¼šè®¾è®¡æ¸¸æˆçŠ¶æ€æœº

è®¾è®¡ä¸€ä¸ªç®€å•æ¸¸æˆçš„çŠ¶æ€æœºï¼ŒåŒ…å«ä»¥ä¸‹çŠ¶æ€ï¼š
- èœå•
- æ¸¸æˆä¸­
- æš‚åœ
- æ¸¸æˆç»“æŸ

### ç»ƒä¹  2ï¼šç”µå•†è®¢å•çŠ¶æ€æœº

è®¾è®¡ä¸€ä¸ªç”µå•†è®¢å•çš„çŠ¶æ€æœºï¼š
- å¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜ â†’ å‘è´§ä¸­ â†’ å·²é€è¾¾
- æ”¯æŒå–æ¶ˆå’Œé€€æ¬¾æµç¨‹

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **çŠ¶æ€æœº = çŠ¶æ€ + è½¬æ¢è§„åˆ™**ï¼šæ¸…æ™°å®šä¹‰ç³»ç»Ÿçš„æ‰€æœ‰å¯èƒ½çŠ¶æ€
2. **LangGraph çš„å¯ŒçŠ¶æ€**ï¼šä¸åªæ˜¯çŠ¶æ€æ ‡è¯†ï¼Œè¿˜åŒ…å«å®Œæ•´æ•°æ®
3. **ä¸å¯å˜æ›´æ–°**ï¼šæ¯æ¬¡è½¬æ¢äº§ç”Ÿæ–°çŠ¶æ€ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **æ¡ä»¶è½¬æ¢**ï¼šæ ¹æ®çŠ¶æ€å†…å®¹åŠ¨æ€å†³å®šä¸‹ä¸€æ­¥
5. **è°ƒè¯•å‹å¥½**ï¼šçŠ¶æ€è¿½è¸ªå’ŒéªŒè¯å¸®åŠ©æ’æŸ¥é—®é¢˜

## ğŸš€ ä¸‹ä¸€æ­¥

æŒæ¡çŠ¶æ€æœºåŸç†åï¼Œæ¥ä¸‹æ¥å­¦ä¹ ï¼š
- `03-å·¥ä½œæµæ¨¡å¼.md` - å¸¸è§çš„å·¥ä½œæµè®¾è®¡æ¨¡å¼
- `../03-LangGraphåŸºç¡€/01-ä¸ºä»€ä¹ˆéœ€è¦LangGraph.md` - å¼€å§‹ LangGraph å®æˆ˜

---

*ç°åœ¨ä½ å·²ç»ç†è§£äº†çŠ¶æ€æœºçš„æ ¸å¿ƒæ€æƒ³ï¼Œè¿™æ˜¯æŒæ¡ LangGraph å·¥ä½œåŸç†çš„å…³é”®ï¼* ğŸ‰